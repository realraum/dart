#!/bin/sh
#
#  dart-sounds
#
#
#  Copyright (C) 2011 Christian Pointner <equinox@realraum.at>
#                         
#  This file is part of dart-sounds.
#
#  dart-sounds is free software: you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation, either version 3 of the License, or
#  any later version.
#
#  dart-sounds is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with dart-sounds. If not, see <http://www.gnu.org/licenses/>.
#

set -e

TARGET=`uname -s`
EBUILD_COMPAT=0

CFLAGS='-g -O2'
LDFLAGS='-g -Wall -O2'

PREFIX='/usr/local'
BINDIR=''

print_usage() {
  echo "configure --help                    print this"
  echo "          --target=<TARGET>         build target i.e. Linux (default: autodetect)"
  echo "          --prefix=<PREFIX>         the installation prefix (default: /usr/local)"
  echo "          --bindir=<DIR>            the path to the bin directory (default: $PREFIX/bin)"
}

for arg
do
  case $arg in
  --target=*)
    TARGET=${arg#--target=}
  ;;
  --prefix=*)
    PREFIX=${arg#--prefix=}
  ;;
  --bindir=*)
    BINDIR=${arg#--bindir=}
  ;;
  --ebuild-compat)
    EBUILD_COMPAT=1
  ;;
  --help)
    print_usage
    exit 0
  ;;
  *)
    ERRORS="$ERRORS $arg"
  ;;
  esac
done

if [ -n "$ERRORS" ] && [ $EBUILD_COMPAT -ne 1 ]; then
  for error in $ERRORS; do
    echo "Unknown argument: $error"
  done

  print_usage
  exit 1
fi

CFLAGS="$CFLAGS $(pkg-config --cflags gstreamer-0.10)"
LDFLAGS="$LDFLAGS $(pkg-config --libs gstreamer-0.10)"

rm -f include.mk
rm -f config.h
case $TARGET in
  Linux)
  ;;
  OpenBSD|FreeBSD|NetBSD|GNU/kFreeBSD)
    CFLAGS=$CFLAGS' -I/usr/local/include'
    LDFLAGS=$LDFLAGS' -L/usr/local/lib'
  ;;
  *)
    echo "platform not supported"
    exit 1;
  ;;
esac

if [ -z "$BINDIR" ]; then
  BINDIR=$PREFIX/bin
fi

if [ -z "$MANDIR" ]; then
  MANDIR=$PREFIX/share/man
fi

cat > include.mk <<EOF
# this file was created automatically
# do not edit this file directly
# use ./configure instead

TARGET := '$TARGET'
CC := gcc
CFLAGS := $CFLAGS
LDFLAGS := $LDFLAGS
STRIP := strip
INSTALL := install
RAGEL := ragel

PREFIX := '$PREFIX'
BINDIR := '$BINDIR'
EOF

HOSTNAME=`hostname`
DATE=`date +"%d.%m.%Y %H:%M:%S %Z"`

cat > config.h <<EOF
/*
 * dart-sounds config header
 *
 * this file was created automatically
 * do not edit this file directly
 * use ./configure instead
 */

#ifndef DART_SOUNDS_config_h_INCLUDED
#define DART_SOUNDS_config_h_INCLUDED

#define VERSION_STRING_0 "dart-sounds version $VERSION"
#define VERSION_STRING_1 "built on $HOSTNAME, $DATE"

#define TARGET "$TARGET"
#define PREFIX "$PREFIX"
#define BINDIR "$BINDIR"

#endif
EOF

exit 0
